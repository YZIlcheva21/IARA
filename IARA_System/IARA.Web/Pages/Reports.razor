@page "/reports"
@using System.Net.Http.Json
@using System.Linq
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>–°–ø—Ä–∞–≤–∫–∏ - –ò–ê–†–ê</PageTitle>

<div class="container-fluid p-4">
    <h1 class="fw-bold mb-4"><span class="oi oi-document me-2"></span>–°–ø—Ä–∞–≤–∫–∏ –∏ –ê–Ω–∞–ª–∏–∑–∏</h1>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h5 class="card-title text-primary">–°–ø—Ä–∞–≤–∫–∞ 1</h5>
                    <p class="card-text small">–ö–æ—Ä–∞–±–∏ —Å –∏–∑—Ç–∏—á–∞—â–æ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ–ª–Ω–æ</p>
                    <div class="mb-3">
                        <label class="form-label small">–î–Ω–∏ –Ω–∞–ø—Ä–µ–¥:</label>
                        <input type="number" class="form-control form-control-sm" @bind="report1Days" min="1" max="365" value="30" />
                    </div>
                    <button class="btn btn-primary btn-sm w-100" @onclick="LoadReport1">–ó–∞—Ä–µ–¥–∏</button>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h5 class="card-title text-success">–°–ø—Ä–∞–≤–∫–∞ 2</h5>
                    <p class="card-text small">–ö–ª–∞—Å–∞—Ü–∏—è –Ω–∞ —Ä–∏–±–∞—Ä–∏ –ª—é–±–∏—Ç–µ–ª–∏</p>
                    <div class="mb-3">
                        <label class="form-label small">–ú–µ—Å–µ—Ü–∏ –Ω–∞–∑–∞–¥:</label>
                        <input type="number" class="form-control form-control-sm" @bind="report2Months" min="1" max="60" value="12" />
                    </div>
                    <button class="btn btn-success btn-sm w-100" @onclick="LoadReport2">–ó–∞—Ä–µ–¥–∏</button>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h5 class="card-title text-info">–°–ø—Ä–∞–≤–∫–∞ 3</h5>
                    <p class="card-text small">–ê–Ω–∞–ª–∏–∑ –Ω–∞ —É–ª–æ–≤–∞ –ø–æ –∫–æ—Ä–∞–±–∏</p>
                    <div class="mb-3">
                        <label class="form-label small">–ì–æ–¥–∏–Ω–∞:</label>
                        <input type="number" class="form-control form-control-sm" @bind="report3Year" min="2000" max="@DateTime.Now.Year" value="@DateTime.Now.Year" />
                    </div>
                    <button class="btn btn-info btn-sm w-100" @onclick="LoadReport3">–ó–∞—Ä–µ–¥–∏</button>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h5 class="card-title text-warning">–°–ø—Ä–∞–≤–∫–∞ 4</h5>
                    <p class="card-text small">–ï—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç –Ω–∞ –≥–æ—Ä–∏–≤–æ—Ç–æ</p>
                    <div class="mb-3">
                        <label class="form-label small">–ì–æ–¥–∏–Ω–∞:</label>
                        <input type="number" class="form-control form-control-sm" @bind="report4Year" min="2000" max="@DateTime.Now.Year" value="@DateTime.Now.Year" />
                    </div>
                    <button class="btn btn-warning btn-sm w-100" @onclick="LoadReport4">–ó–∞—Ä–µ–¥–∏</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report 1: Expiring Licenses -->
    @if (showReport1)
    {
    <div class="card shadow-lg border-0 mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">–°–ø—Ä–∞–≤–∫–∞ 1: –ö–æ—Ä–∞–±–∏ —Å –∏–∑—Ç–∏—á–∞—â–æ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ–ª–Ω–æ (—Å–ª–µ–¥–≤–∞—â–∏—Ç–µ @report1Days –¥–Ω–∏)</h4>
        </div>
        <div class="card-body">
            @if (loadingReport1)
            {
            <div class="text-center p-4">
                <div class="spinner-border text-primary"></div>
            </div>
            }
            else if (expiringLicenses != null && expiringLicenses.Any())
            {
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>–ù–æ–º–µ—Ä –Ω–∞ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ–ª–Ω–æ</th>
                            <th>–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–µ–Ω –Ω–æ–º–µ—Ä –Ω–∞ –∫–æ—Ä–∞–±</th>
                            <th>–°–æ–±—Å—Ç–≤–µ–Ω–∏–∫</th>
                            <th>–î–∞—Ç–∞ –Ω–∞ –∏–∑—Ç–∏—á–∞–Ω–µ</th>
                            <th>–û—Å—Ç–∞–≤–∞—â–∏ –¥–Ω–∏</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var license in expiringLicenses)
                        {
                        <tr class="@(license.DaysRemaining <= 7 ? "table-warning" : "")">
                            <td><strong>@license.LicenseNumber</strong></td>
                            <td>@license.ShipInternationalNumber</td>
                            <td>@license.OwnerName</td>
                            <td>@license.ExpiryDate.ToString("dd.MM.yyyy")</td>
                            <td>
                                <span class="badge @(license.DaysRemaining <= 7 ? "bg-danger" : "bg-warning")">
                                    @license.DaysRemaining –¥–Ω–∏
                                </span>
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
            }
            else
            {
            <div class="alert alert-info">–ù—è–º–∞ –∫–æ—Ä–∞–±–∏ —Å –∏–∑—Ç–∏—á–∞—â–∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ–ª–Ω–∏ –≤ —Ç–æ–∑–∏ –ø–µ—Ä–∏–æ–¥.</div>
            }
        </div>
    </div>
    }

    <!-- Report 2: Amateur Ranking -->
    @if (showReport2)
    {
    <div class="card shadow-lg border-0 mb-4">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0">–°–ø—Ä–∞–≤–∫–∞ 2: –ö–ª–∞—Å–∞—Ü–∏—è –Ω–∞ —Ä–∏–±–∞—Ä–∏ –ª—é–±–∏—Ç–µ–ª–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏—Ç–µ @report2Months –º–µ—Å–µ—Ü–∞)</h4>
        </div>
        <div class="card-body">
            @if (loadingReport2)
            {
            <div class="text-center p-4">
                <div class="spinner-border text-success"></div>
            </div>
            }
            else if (amateurRanking != null && amateurRanking.Any())
            {
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>–ú—è—Å—Ç–æ</th>
                            <th>–ò–º–µ –Ω–∞ —Ä–∏–±–∞—Ä</th>
                            <th>–û–±—â —É–ª–æ–≤ (–∫–≥)</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{ int rank = 1; }
                        @foreach (var fisher in amateurRanking.OrderByDescending(x => x.TotalCatchInKgs))
                        {
                        <tr>
                            <td>
                                @if (rank == 1)
                                {
                                <span class="badge bg-warning text-dark">ü•á @rank</span>
                                }
                                else if (rank == 2)
                                {
                                <span class="badge bg-secondary">ü•à @rank</span>
                                }
                                else if (rank == 3)
                                {
                                <span class="badge bg-warning">ü•â @rank</span>
                                }
                                else
                                {
                                <span>@rank</span>
                                }
                            </td>
                            <td><strong>@fisher.FisherName</strong></td>
                            <td><strong>@fisher.TotalCatchInKgs.ToString("F2") –∫–≥</strong></td>
                        </tr>
                        rank++;
                        }
                    </tbody>
                </table>
            </div>
            }
            else
            {
            <div class="alert alert-info">–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –ª—é–±–∏—Ç–µ–ª—Å–∫–∏ —É–ª–æ–≤ –≤ —Ç–æ–∑–∏ –ø–µ—Ä–∏–æ–¥.</div>
            }
        </div>
    </div>
    }

    <!-- Report 3: Ship Catch Analysis -->
    @if (showReport3)
    {
    <div class="card shadow-lg border-0 mb-4">
        <div class="card-header bg-info text-white">
            <h4 class="mb-0">–°–ø—Ä–∞–≤–∫–∞ 3: –ê–Ω–∞–ª–∏–∑ –Ω–∞ —É–ª–æ–≤–∞ –ø–æ –∫–æ—Ä–∞–±–∏ –∑–∞ @report3Year –≥.</h4>
        </div>
        <div class="card-body">
            @if (loadingReport3)
            {
            <div class="text-center p-4">
                <div class="spinner-border text-info"></div>
            </div>
            }
            else if (shipCatchAnalysis != null && shipCatchAnalysis.Any())
            {
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–µ–Ω –Ω–æ–º–µ—Ä</th>
                            <th>–ë—Ä–æ–π –∏–∑–ª–µ—Ç–∏</th>
                            <th>–û–±—â —É–ª–æ–≤ (–∫–≥)</th>
                            <th>–ú–∏–Ω. —É–ª–æ–≤/–∏–∑–ª–µ—Ç (–∫–≥)</th>
                            <th>–ú–∞–∫—Å. —É–ª–æ–≤/–∏–∑–ª–µ—Ç (–∫–≥)</th>
                            <th>–°—Ä–µ–¥–µ–Ω —É–ª–æ–≤/–∏–∑–ª–µ—Ç (–∫–≥)</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var ship in shipCatchAnalysis.OrderByDescending(x => x.TotalCatchKgs))
                        {
                        <tr>
                            <td><strong>@ship.ShipInternationalNumber</strong></td>
                            <td>@ship.TotalTrips</td>
                            <td><strong>@ship.TotalCatchKgs.ToString("F2")</strong></td>
                            <td>@ship.MinCatchPerTripKgs.ToString("F2")</td>
                            <td>@ship.MaxCatchPerTripKgs.ToString("F2")</td>
                            <td><strong>@ship.AvgCatchPerTripKgs.ToString("F2")</strong></td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
            }
            else
            {
            <div class="alert alert-info">–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ —É–ª–æ–≤ –ø—Ä–µ–∑ @report3Year –≥.</div>
            }
        </div>
    </div>
    }

    <!-- Report 4: Fuel Efficiency -->
    @if (showReport4)
    {
    <div class="card shadow-lg border-0 mb-4">
        <div class="card-header bg-warning text-dark">
            <h4 class="mb-0">–°–ø—Ä–∞–≤–∫–∞ 4: –ï—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç –Ω–∞ –≥–æ—Ä–∏–≤–æ—Ç–æ –∑–∞ @report4Year –≥.</h4>
        </div>
        <div class="card-body">
            @if (loadingReport4)
            {
            <div class="text-center p-4">
                <div class="spinner-border text-warning"></div>
            </div>
            }
            else if (fuelEfficiency != null && fuelEfficiency.Any())
            {
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–µ–Ω –Ω–æ–º–µ—Ä</th>
                            <th>–û–±—â —É–ª–æ–≤ (–∫–≥)</th>
                            <th>–û–±—â–æ –≥–æ—Ä–∏–≤–æ (–∫–≥)</th>
                            <th>–û–±—â–æ —á–∞—Å–æ–≤–µ</th>
                            <th>–ì–æ—Ä–∏–≤–æ/–∫–≥ —É–ª–æ–≤</th>
                            <th>–°—Ä–µ–¥–µ–Ω —Ä–∞–∑—Ö–æ–¥/—á–∞—Å</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var ship in fuelEfficiency.OrderBy(x => x.FuelPerKgCatch))
                        {
                        <tr>
                            <td><strong>@ship.ShipInternationalNumber</strong></td>
                            <td>@ship.TotalCatchKgs.ToString("F2")</td>
                            <td>@ship.TotalFuelUsed.ToString("F2")</td>
                            <td>@ship.TotalFishingHours.ToString("F1")</td>
                            <td><strong>@ship.FuelPerKgCatch.ToString("F3")</strong></td>
                            <td>@ship.AvgFuelPerHour.ToString("F2")</td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
            }
            else
            {
            <div class="alert alert-info">–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç –Ω–∞ –≥–æ—Ä–∏–≤–æ—Ç–æ –ø—Ä–µ–∑ @report4Year –≥.</div>
            }
        </div>
    </div>
    }
</div>

@code {
    private int report1Days = 30;
    private int report2Months = 12;
    private int report3Year = DateTime.Now.Year;
    private int report4Year = DateTime.Now.Year;

    private bool showReport1 = false;
    private bool showReport2 = false;
    private bool showReport3 = false;
    private bool showReport4 = false;

    private bool loadingReport1 = false;
    private bool loadingReport2 = false;
    private bool loadingReport3 = false;
    private bool loadingReport4 = false;

    private ExpiringLicenseDto[]? expiringLicenses;
    private AmateurRankingDto[]? amateurRanking;
    private ShipCatchAnalysisDto[]? shipCatchAnalysis;
    private ShipFuelEfficiencyDto[]? fuelEfficiency;

    private async Task LoadReport1()
    {
        try
        {
            loadingReport1 = true;
            showReport1 = true;
            var response = await Http.GetFromJsonAsync<ExpiringLicenseDto[]>($"api/Reports/expiring-licenses?daysAhead={report1Days}");
            expiringLicenses = response;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Å–ø—Ä–∞–≤–∫–∞ 1: {ex.Message}");
        }
        finally
        {
            loadingReport1 = false;
        }
    }

    private async Task LoadReport2()
    {
        try
        {
            loadingReport2 = true;
            showReport2 = true;
            var response = await Http.GetFromJsonAsync<AmateurRankingDto[]>($"api/Reports/amateur-ranking?lastMonths={report2Months}");
            amateurRanking = response;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Å–ø—Ä–∞–≤–∫–∞ 2: {ex.Message}");
        }
        finally
        {
            loadingReport2 = false;
        }
    }

    private async Task LoadReport3()
    {
        try
        {
            loadingReport3 = true;
            showReport3 = true;
            var response = await Http.GetFromJsonAsync<ShipCatchAnalysisDto[]>($"api/Reports/ship-catch-analysis/{report3Year}");
            shipCatchAnalysis = response;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Å–ø—Ä–∞–≤–∫–∞ 3: {ex.Message}");
        }
        finally
        {
            loadingReport3 = false;
        }
    }

    private async Task LoadReport4()
    {
        try
        {
            loadingReport4 = true;
            showReport4 = true;
            var response = await Http.GetFromJsonAsync<ShipFuelEfficiencyDto[]>($"api/Reports/ship-fuel-efficiency/{report4Year}");
            fuelEfficiency = response;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Å–ø—Ä–∞–≤–∫–∞ 4: {ex.Message}");
        }
        finally
        {
            loadingReport4 = false;
        }
    }

    // DTO Classes
    public class ExpiringLicenseDto
    {
        public int LicenseId { get; set; }
        public string LicenseNumber { get; set; } = string.Empty;
        public string ShipInternationalNumber { get; set; } = string.Empty;
        public string OwnerName { get; set; } = string.Empty;
        public DateTime ExpiryDate { get; set; }
        public int DaysRemaining { get; set; }
    }

    public class AmateurRankingDto
    {
        public int FisherId { get; set; }
        public string FisherName { get; set; } = string.Empty;
        public double TotalCatchInKgs { get; set; }
    }

    public class ShipCatchAnalysisDto
    {
        public string ShipInternationalNumber { get; set; } = string.Empty;
        public int TotalTrips { get; set; }
        public double TotalCatchKgs { get; set; }
        public double MaxCatchPerTripKgs { get; set; }
        public double MinCatchPerTripKgs { get; set; }
        public double AvgCatchPerTripKgs { get; set; }
    }

    public class ShipFuelEfficiencyDto
    {
        public string ShipInternationalNumber { get; set; } = string.Empty;
        public double TotalCatchKgs { get; set; }
        public double TotalFuelUsed { get; set; }
        public double TotalFishingHours { get; set; }
        public double FuelPerKgCatch { get; set; }
        public double AvgFuelPerHour { get; set; }
    }
}
