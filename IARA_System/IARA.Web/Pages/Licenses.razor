@page "/licenses"
@using System.Net.Http.Json
@using System.Linq
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Разрешителни - ИАРА</PageTitle>

<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold"><span class="oi oi-document me-2"></span>Разрешителна за риболов</h1>
        <button class="btn btn-primary rounded-pill px-4">+ Ново Разрешително</button>
    </div>

    <div class="row mb-3">
        <div class="col-md-3">
            <select class="form-select" @bind="statusFilter" @bind:event="onchange">
                <option value="">Всички статуси</option>
                <option value="Active">Активни</option>
                <option value="Expired">Изтекли</option>
                <option value="Revoked">Отнети</option>
            </select>
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" placeholder="Търсене по номер..." @bind="searchTerm" @bind:event="oninput" />
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-primary w-100" @onclick="LoadLicenses">Търси</button>
        </div>
        <div class="col-md-2">
            <div class="form-check form-switch mt-2">
                <input class="form-check-input" type="checkbox" @bind="expiringSoonFilter" @bind:event="onchange" />
                <label class="form-check-label">Изтичащи скоро</label>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
    <div class="text-center p-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">Зареждане на разрешителни...</p>
    </div>
    }
    else if (licenses == null || !licenses.Any())
    {
    <div class="alert alert-info text-center">Няма намерени разрешителни</div>
    }
    else
    {
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Номер</th>
                    <th>Рибар</th>
                    <th>Кораб</th>
                    <th>Дата на издаване</th>
                    <th>Дата на изтичане</th>
                    <th>Статус</th>
                    <th>Тип</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var license in licenses)
                {
                <tr>
                    <td><strong>@license.LicenseNumber</strong></td>
                    <td>@(license.FisherName ?? "N/A")</td>
                    <td>@(license.ShipName ?? "N/A")</td>
                    <td>@license.IssueDate.ToString("dd.MM.yyyy")</td>
                    <td>
                        @if (license.ExpiryDate.HasValue)
                        {
                        var daysRemaining = (license.ExpiryDate.Value - DateTime.Now).Days;
                        <span class="@(daysRemaining <= 30 ? "text-danger fw-bold" : "")">
                            @license.ExpiryDate.Value.ToString("dd.MM.yyyy")
                            @if (daysRemaining <= 30 && daysRemaining >= 0)
                            {
                            <span class="badge bg-warning">@daysRemaining дни</span>
                            }
                        </span>
                        }
                        else
                        {
                        <span class="text-muted">N/A</span>
                        }
                    </td>
                    <td>
                        @if (license.Status == "Active")
                        {
                        <span class="badge bg-success">Активно</span>
                        }
                        else if (license.Status == "Expired")
                        {
                        <span class="badge bg-secondary">Изтекло</span>
                        }
                        else if (license.Status == "Revoked")
                        {
                        <span class="badge bg-danger">Отнето</span>
                        }
                        else
                        {
                        <span class="badge bg-secondary">@license.Status</span>
                        }
                    </td>
                    <td>@(license.LicenseType ?? "N/A")</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" title="Преглед">
                            <span class="oi oi-eye"></span>
                        </button>
                    </td>
                </tr>
                }
            </tbody>
        </table>
    </div>
    }
</div>

@code {
    private LicenseDto[]? licenses;
    private bool isLoading = false;
    private string statusFilter = "";
    private string searchTerm = "";
    private bool expiringSoonFilter = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadLicenses();
    }

    private async Task LoadLicenses()
    {
        try
        {
            isLoading = true;
            var queryParams = new List<string>();
            
            if (!string.IsNullOrEmpty(statusFilter))
                queryParams.Add($"status={statusFilter}");
            
            if (expiringSoonFilter)
                queryParams.Add("expiringSoon=true");
            
            var queryString = queryParams.Any() ? "?" + string.Join("&", queryParams) : "";
            var response = await Http.GetFromJsonAsync<LicenseDto[]>($"api/Licenses{queryString}");
            licenses = response;
            
            // Apply client-side search if needed
            if (!string.IsNullOrEmpty(searchTerm) && licenses != null)
            {
                licenses = licenses.Where(l => 
                    l.LicenseNumber.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    (l.FisherName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (l.ShipName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
                ).ToArray();
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Грешка при зареждане: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    public class LicenseDto
    {
        public int Id { get; set; }
        public string LicenseNumber { get; set; } = string.Empty;
        public int FisherId { get; set; }
        public string? FisherName { get; set; }
        public int? ShipId { get; set; }
        public string? ShipName { get; set; }
        public DateTime IssueDate { get; set; }
        public DateTime? ExpiryDate { get; set; }
        public string Status { get; set; } = string.Empty;
        public string? LicenseType { get; set; }
    }
}
